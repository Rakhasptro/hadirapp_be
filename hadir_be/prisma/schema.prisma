generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Model untuk jadwal perkuliahan yang dibuat teacher
model course_schedules {
  id          String                  @id @default(uuid())
  teacherId   String
  courseName  String // Nama mata kuliah
  courseCode  String // Kode mata kuliah
  date        DateTime                @db.Date // Tanggal perkuliahan
  startTime   String // Format: "08:00"
  endTime     String // Format: "10:00"
  room        String? // Ruangan (optional)
  topic       String? // Topik perkuliahan (optional)
  qrCode      String?                 @unique // Token untuk QR code
  qrCodeImage String?                 @db.Text // Base64 image atau URL
  status      course_schedules_status @default(SCHEDULED)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  teachers    teachers                @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  attendances attendances[]

  @@index([teacherId], map: "course_schedules_teacherId_fkey")
}

// Model untuk absensi mahasiswa
model attendances {
  id              String             @id @default(uuid())
  scheduleId      String
  studentName     String // Input manual dari mahasiswa
  studentNpm      String // NPM mahasiswa (input manual)
  studentEmail    String?            // Optional email of the student who submitted
  selfieImage     String // Path atau URL foto selfie
  status          attendances_status @default(PENDING)
  confirmedBy     String? // Teacher ID yang confirm
  confirmedAt     DateTime?
  rejectionReason String?            @db.Text // Alasan jika ditolak
  scannedAt       DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  schedule        course_schedules   @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, studentNpm]) // 1 mahasiswa hanya bisa absen 1x per schedule
  @@index([scheduleId], map: "attendances_scheduleId_fkey")
  @@index([status], map: "attendances_status_idx")
}

// Model teachers (simplified - hanya yang diperlukan)
model teachers {
  id               String             @id @default(uuid())
  userId           String             @unique
  nip              String             @unique
  name             String
  email            String?
  gender           String?            @db.Char(1)
  phone            String?
  photo            String?
  address          String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  users            users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  course_schedules course_schedules[]
}

model users {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  role      users_role @default(TEACHER)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  teachers  teachers?
}

// Enums
enum users_role {
  TEACHER
  STUDENT
}

enum course_schedules_status {
  SCHEDULED // Jadwal dibuat, QR belum aktif
  ACTIVE // QR code aktif, mahasiswa bisa scan
  CLOSED // Sesi selesai, tidak bisa scan lagi
}

enum attendances_status {
  PENDING // Menunggu konfirmasi teacher
  CONFIRMED // Sudah dikonfirmasi teacher (hadir)
  REJECTED // Ditolak teacher
}
